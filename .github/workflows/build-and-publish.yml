name: Build and Publish Package

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'PKGBUILD'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build package and create repository
        run: |
          # Run build in Arch Linux container
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            archlinux:latest \
            bash -c '
              # Update system and install build dependencies
              pacman -Syu --noconfirm
              pacman -S --noconfirm base-devel git python python-setuptools python-cffi

              # Create a build user (makepkg cannot run as root)
              useradd -m -G wheel builder
              echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
              chown -R builder:builder /workspace

              # Build package
              su builder -c "cd /workspace && makepkg -s --noconfirm"

              # Create repo directory and move packages
              mkdir -p /workspace/repo
              mv /workspace/*.pkg.tar.zst /workspace/repo/

              # Create repository database
              cd /workspace/repo
              repo-add archzfs.db.tar.gz *.pkg.tar.zst

              # Prepare Pages directory structure
              cd /workspace
              mkdir -p _site
              cp -r repo _site/

              # Fix permissions for all files
              chmod -R 777 /workspace/_site
            '

      - name: Generate repository index
        run: |
          # Generate base HTML
          bash .github/workflows/generate-index.sh _site/repo/index.html

          # Generate package file list
          cd _site/repo
          PACKAGE_LIST=""
          for file in *.pkg.tar.zst *.db.tar.gz *.db *.files.tar.gz *.files 2>/dev/null; do
            if [ -f "$file" ]; then
              PACKAGE_LIST="${PACKAGE_LIST}<li><a href=\"${file}\">${file}</a></li>\n"
            fi
          done

          # Insert package list into HTML
          if [ -n "$PACKAGE_LIST" ]; then
            sed -i "s|<!-- Package list will be inserted here during build -->|${PACKAGE_LIST}|" index.html
          else
            sed -i "s|<!-- Package list will be inserted here during build -->|<li>No packages found</li>|" index.html
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
